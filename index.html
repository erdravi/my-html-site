<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grocery List App</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: white;
      color: black;
    }
    body.dark {
      background-color: #121212;
      color: white;
    }
    header {
      background-color: #4A90E2;
      color: white;
      padding: 10px;
      text-align: center;
    }
    nav {
      display: flex;
      justify-content: space-around;
      background-color: #f1f1f1;
    }
    nav button {
      flex: 1;
      padding: 10px;
      border: none;
      background-color: #ddd;
      cursor: pointer;
      font-size: 16px;
    }
    nav button.active {
      background-color: #4A90E2;
      color: white;
    }
    .tab {
      display: none;
      padding: 20px;
    }
    .tab.active {
      display: block;
    }
    input, select, button, textarea {
      margin: 5px;
      padding: 5px;
      font-size: 14px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      margin: 5px 0;
    }
    .checked {
      text-decoration: line-through;
      color: gray;
    }
    .delete-btn, .edit-btn {
      margin-left: 10px;
      cursor: pointer;
    }
    .delete-btn {
      color: red;
    }
    .edit-btn {
      color: orange;
    }
    .summary {
      margin-top: 10px;
      font-weight: bold;
    }
    .dark-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Grocery List Manager</h1>
    <button class="dark-toggle" onclick="toggleDarkMode()">üåô</button>
  </header>
  <nav>
    <button onclick="showTab('master', this)" class="active">Master</button>
    <button onclick="showTab('buy', this)">Buy List</button>
    <button onclick="showTab('checklist', this)">Checklist</button>
    <button onclick="showTab('backup', this)">Backup</button>
  </nav>

  <div id="master" class="tab active">
    <h2>Master Items</h2>
    <input type="text" id="masterItem" placeholder="Enter item" />
    <button onclick="addMasterItem()">Add</button>
    <ul id="masterList"></ul>
    <div class="summary">Total items: <span id="masterCount">0</span></div>
  </div>

  <div id="buy" class="tab">
    <h2>Buy List</h2>
    <select id="buyItem"></select>
    <input type="number" id="buyQuantity" placeholder="Quantity" />
    <select id="buyUnit">
      <option value="gram">gram</option>
      <option value="kg">kg</option>
      <option value="small pack">small pack</option>
      <option value="medium pack">medium pack</option>
      <option value="large pack">large pack</option>
      <option value="liters">liters</option>
      <option value="item">item</option>
    </select>
    <input type="month" id="buyMonth" />
    <button onclick="addToBuyList()">Add</button>
    <ul id="buyList"></ul>
    <div class="summary">Total buy items: <span id="buyCount">0</span></div>
    <button onclick="sortBuyList()">Sort by Item</button>
    <button onclick="exportBuyList()">Export CSV</button>
  </div>

  <div id="checklist" class="tab">
    <h2>Checklist</h2>
    <select id="monthSelect" onchange="filterChecklist()">
      <option value="">All Months</option>
    </select>
    <ul id="checklistItems"></ul>
    <div class="summary">Purchased: <span id="purchasedCount">0</span> | Pending: <span id="pendingCount">0</span></div>
  </div>

  <div id="backup" class="tab">
    <h2>Backup / Restore</h2>
    <button onclick="backupData()">Download Backup</button>
    <input type="file" id="fileInput" onchange="restoreData()" />
  </div>

  <script>
    const masterList = JSON.parse(localStorage.getItem("masterList")) || [];
    const buyList = JSON.parse(localStorage.getItem("buyList")) || [];
    const checklist = JSON.parse(localStorage.getItem("checklist")) || [];
    let editIndex = -1;

    function getCurrentMonth() {
      return new Date().toISOString().slice(0, 7);
    }

    function showTab(tabId, el = null) {
      document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
      document.querySelectorAll("nav button").forEach(btn => btn.classList.remove("active"));
      document.getElementById(tabId).classList.add("active");
      if (el) el.classList.add("active");

      if (tabId === "buy") {
        renderBuyList();
        updateBuyDropdown();
        document.getElementById("buyMonth").value = getCurrentMonth();
      }
      if (tabId === "checklist") {
        populateMonthDropdown();
        filterChecklist();
      }
      if (tabId === "master") renderMasterList();
    }

    function addMasterItem() {
      const item = document.getElementById("masterItem").value.trim();
      if (item && !masterList.includes(item)) {
        masterList.push(item);
        localStorage.setItem("masterList", JSON.stringify(masterList));
        document.getElementById("masterItem").value = "";
        renderMasterList();
      }
    }

    function renderMasterList() {
      const ul = document.getElementById("masterList");
      ul.innerHTML = "";
      masterList.forEach((item, i) => {
        ul.innerHTML += `<li>${i + 1}. ${item} <span class="delete-btn" onclick="deleteMasterItem(${i})">üóëÔ∏è</span></li>`;
      });
      document.getElementById("masterCount").innerText = masterList.length;
    }

    function deleteMasterItem(index) {
      masterList.splice(index, 1);
      localStorage.setItem("masterList", JSON.stringify(masterList));
      renderMasterList();
    }

    function updateBuyDropdown() {
      const dropdown = document.getElementById("buyItem");
      dropdown.innerHTML = `<option value="">Select item</option>`;
      masterList.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item;
        opt.textContent = item;
        dropdown.appendChild(opt);
      });
    }

    function addToBuyList() {
      const item = document.getElementById("buyItem").value;
      const quantity = document.getElementById("buyQuantity").value;
      const unit = document.getElementById("buyUnit").value;
      const date = document.getElementById("buyMonth").value;

      if (item && quantity && unit && date) {
        const duplicate = buyList.find(b => b.item === item && b.date === date);
        if (duplicate && editIndex === -1) {
          alert("Duplicate item for the same month already exists.");
          return;
        }

        if (editIndex >= 0) {
          buyList[editIndex] = { item, quantity, unit, date };
          editIndex = -1;
        } else {
          buyList.push({ item, quantity, unit, date });
        }

        localStorage.setItem("buyList", JSON.stringify(buyList));
        syncChecklist();
        renderBuyList();
        document.getElementById("buyItem").value = "";
        document.getElementById("buyQuantity").value = "";
      }
    }

    function editBuyItem(index) {
      const b = buyList[index];
      document.getElementById("buyItem").value = b.item;
      document.getElementById("buyQuantity").value = b.quantity;
      document.getElementById("buyUnit").value = b.unit;
      document.getElementById("buyMonth").value = b.date;
      editIndex = index;
    }

    function deleteBuyItem(index) {
      const removed = buyList.splice(index, 1)[0];
      const cIndex = checklist.findIndex(c => c.item === removed.item && c.date === removed.date);
      if (cIndex >= 0) checklist.splice(cIndex, 1);
      localStorage.setItem("buyList", JSON.stringify(buyList));
      localStorage.setItem("checklist", JSON.stringify(checklist));
      renderBuyList();
    }

    function renderBuyList() {
      const ul = document.getElementById("buyList");
      ul.innerHTML = "";
      buyList.forEach((b, i) => {
        ul.innerHTML += `<li>${i + 1}. ${b.item} - ${b.quantity} ${b.unit}  
        <span class="edit-btn" onclick="editBuyItem(${i})">‚úèÔ∏è</span>
        <span class="delete-btn" onclick="deleteBuyItem(${i})">üóëÔ∏è</span></li>`;
      });
      document.getElementById("buyCount").innerText = buyList.length;
    }

    function syncChecklist() {
      buyList.forEach(b => {
        const exists = checklist.find(c => c.item === b.item && c.date === b.date);
        if (!exists) checklist.push({ ...b, checked: false });
      });
      localStorage.setItem("checklist", JSON.stringify(checklist));
    }

    function populateMonthDropdown() {
      const dropdown = document.getElementById("monthSelect");
      const months = [...new Set(checklist.map(c => c.date))];
      dropdown.innerHTML = `<option value="">All Months</option>`;
      months.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        dropdown.appendChild(opt);
      });
    }

    function filterChecklist() {
      const month = document.getElementById("monthSelect").value;
      const ul = document.getElementById("checklistItems");
      const filtered = month ? checklist.filter(c => c.date === month) : checklist;
      ul.innerHTML = "";
      let purchased = 0;
      filtered.forEach((c) => {
        if (c.checked) purchased++;
        ul.innerHTML += `<li><input type="checkbox" onchange="toggleChecked(this, '${c.item}', '${c.date}')" ${c.checked ? "checked" : ""} />
        <span class="${c.checked ? 'checked' : ''}">${c.item} - ${c.quantity} ${c.unit}</span></li>`;
      });
      document.getElementById("purchasedCount").innerText = purchased;
      document.getElementById("pendingCount").innerText = filtered.length - purchased;
    }

    function toggleChecked(checkbox, item, date) {
      const index = checklist.findIndex(c => c.item === item && c.date === date);
      if (index >= 0) {
        checklist[index].checked = checkbox.checked;
        localStorage.setItem("checklist", JSON.stringify(checklist));
        filterChecklist();
      }
    }

    function exportBuyList() {
      let csv = "Item,Quantity,Unit,Date\n";
      buyList.forEach(b => csv += `${b.item},${b.quantity},${b.unit},${b.date}\n`);
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "buy_list.csv";
      a.click();
    }

    function backupData() {
      const data = { masterList, buyList, checklist };
      const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "grocery_backup.json";
      a.click();
    }

    function restoreData() {
      const file = document.getElementById("fileInput").files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = JSON.parse(e.target.result);
        localStorage.setItem("masterList", JSON.stringify(data.masterList));
        localStorage.setItem("buyList", JSON.stringify(data.buyList));
        localStorage.setItem("checklist", JSON.stringify(data.checklist));
        location.reload();
      };
      reader.readAsText(file);
    }

    function sortBuyList() {
      buyList.sort((a, b) => a.item.localeCompare(b.item));
      localStorage.setItem("buyList", JSON.stringify(buyList));
      renderBuyList();
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark");
    }

    // Initialize
    renderMasterList();
    renderBuyList();
    syncChecklist();
    populateMonthDropdown();
    filterChecklist();
  </script>
</body>
</html>
